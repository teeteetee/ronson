doctype html(lang='en')
head
    meta(charset='utf-8')
    |     
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    |     
    meta(name='viewport', content='width=device-width, initial-scale=1')
    |     
    title Recent ones
    // Bootstrap
    link(href='/bootstrap/css/bootstrap.min.css', rel='stylesheet')
    // HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries
    // WARNING: Respond.js doesn't work if you view the page via file://
    //if lt IE 9
      script(src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js')
      |       
      script(src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js')     
    style.
      @font-face {
      font-family:roboto-thin;
      src:url('/bootstrap/fonts/Roboto-Thin.ttf');
      }
      @font-face {
      font-family:high;
      src: url('/bootstrap/fonts/Attentica.ttf');
      }
      @font-face {
      font-family:br;
      src: url('/bootstrap/fonts/bebasneue_regular.ttf');
      }
      @font-face {
      font-family:bt;
      src: url('/bootstrap/fonts/bebasneue_thin.ttf');
      }
      h1 {
      font-size:1vw;
      font-family:arial;
      letter-spacing:0.3vw;
      text-transform:uppercase;
      color:#bbb;
      margin-top:0px;
      margin-bottom:0px;
      }
      body {
      min-width:768px;
      background-color:#fff;
      background-image:url('/bootstrap/images/stripe4.png');
      filter: grayscale(50%);
      }
      h2 {
      font-size:6vw;
      font-family:br;
      letter-spacing:7px;
      }
      h3 {
      font-size:3vw;
      }
      h4 {
      font-size:2vw;
      font-family:roboto-thin;
      letter-spacing:0.3vw;
      text-transform:uppercase;
      }
      h5 {
      letter-spacing:2px;
      text-transform:uppercase;
      font-family:high;
      color:white;
      font-size:3vw;
      margin-bottom:0px;
      }
      .preview {
      margin:0px;
      padding:0px;
      border-right:1px solid black;
      -webkit-filter: grayscale(100%);
      -moz-filter: grayscale(100%);
      -o-filter: grayscale(100%);
      -ms-filter: grayscale(100%);
      }
      .preview:hover {
      -webkit-filter: grayscale(0%);
      -moz-filter: grayscale(0%);
      -o-filter: grayscale(0%);
      -ms-filter: grayscale(0%);
      }
      img {
      width:100%;
      }
      .imgrow {
      border-bottom:1px solid black;
      }
      .placenamebckgrnd {
      position:absolute;
      color:white;
      opacity:0.7;
      width:100%;
      margin-bottom:auto;
      background-color:black;
      text-align:center;
      z-index:1;
      height:25%;
      }
      .placename {
      position:absolute;
      color:black;
      width:100%;
      text-align:center;
      margin-bottom:auto;
      z-index:2;
      }
      #header {
      background-color:gray;
      }
      .spart{
      height:2vh;
      background-color:#333;
      }
      .color {
      height:10vh;
      }
      #blue{
      background-color:#001c45;
      }
      #green{
      background-color:#49a881;
      }
      #white{
      background-color:white;
      }
      .imgrow {
      background-color:#333;
      }
      .container-fluid {
      min-height:100vh;
      background-color:#eee;
      }  
      #timeperiod{
        background-color:black;
      }
      .albumnameblock{
      z-index:200;
      top:0px;
      background-color:#fff;
      padding:1vh;
      }
      a:hover {
        text-decoration:none;
        outline:none;
      }
  body
    .container
      #header.row
        .col-xs-2(style='padding-top:15px;padding-bottom:15px;')
          img(id='logo',src='/bootstrap/images/rl.png',style='width:100%;') 
        .col-xs-10(style='text-align:left;')
          h5(style='color:white;font-family:roboto-thin;font-size:4vw;') Панорамы недавно открывшихся заведений и агретор рейтингов. 
                 
      #timeperiod.row
        .col-xs-4(style='border-right:1px dotted gray;text-align:center;')
          h2(style='color:white;') Лента: 
        |           
        a(href='/top')
          .col-xs-4(style='border-right:1px dotted gray;text-align:center;')
            h2(style='color:gray;') Рейтинги 
        |           
        a(href='/search')
          .col-xs-4(style='text-align:center;')
            h2(style='color:gray;') Поиск        
        
      .row(style='background-color:#eee;')
        #inserts.col-xs-12(style='text-align:center;')
      .row(style='text-align:center;background-color:#fff;')
        .col-xs-12
          h5(id='more',style='color:gray;margin-bottom:10px;cursor:pointer;') Еще 
      #footer.row(style='background-color:white;padding-bottom:10px;')  
        .col-xs-2.col-xs-offset-3(style='text-align:right;')
          a(href='/misc/1')
            h1 Контакты
        .col-xs-2(style='text-align:center;')
          a(href='/misc/2')
            h1 Манифест
        .col-xs-2(style='text-align:left;')
          a(href='/misc/3')
            h1 Опасность

      script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js')
      script.
        var moreid = 0;
        var logocount=0;
        $('#logo').mouseenter(function(){
          if(logocount<3)
           {switch(logocount) {
                       case(0):
                        $('#logo').attr('src','/bootstrap/images/gl.png');
                        logocount++;
                       break;
                       case(1):
                        $('#logo').attr('src','/bootstrap/images/bl.png');
                        logocount++;
                       break;
                       case(2):
                         $('#logo').attr('src','/bootstrap/images/rl.png');
                        logocount++;
                       break;
                      }
                    }
            else {
              switch(logocount%3)
              {         case(0):
                         $('#logo').attr('src','/bootstrap/images/gl.png');
                         logocount++;
                        break;
                        case(1):
                         $('#logo').attr('src','/bootstrap/images/bl.png');
                         logocount++;
                        break;
                        case(2):
                         $('#logo').attr('src','/bootstrap/images/rl.png');
                         logocount++;
                        break;}
            }
          });
        var toplist = !{doc};
        function populate(toplist) {console.log("first time: "+toplist);
                //toplist = JSON.parse(toplist);
                //console.log("second time: "+toplist);
                var left = toplist.length%3;
                console.log('LEFT IS: '+left);
                var times = (toplist.length-left)/3;
                console.log('TIMES IS: '+times);
                if(toplist.length<3){
                  $('#inserts').append("<div class='row' id='row1'></div>");
                  for (var i=0;i<toplist.length;i++){
                    var cellnum = i+1;
                    var insert = "<div class='col-xs-4' style='padding:0px;' id='ratcell"+cellnum+"'><div class='albumnameblock'><h5 style='color:black;'>"+toplist[i].placenameru+"</h5><h1>"+toplist[i].regdate.day+"."+toplist[i].regdate.month+"."+toplist[i].regdate.year+"</h1></div><a href='http://recentones.com/places/"+toplist[i].pid+"'><img src='"+toplist[i].mainpreview+"' style='width:100%;'></a></div>";
                    eval("$('#row1').append(insert);");
                  }
                }
                else{
                for (var xx=0;xx<times;xx++)
                { 
                  var rnum = xx+1;
                  $('#inserts').append("<div class='row' id='row"+rnum+"'></div>");
                  for (var i=0;i<3;i++){
                    var cellnum = xx*3+i+1;
                    var hnum = cellnum-1;
                    if(i===2)
                    {
                     var insert = "<div class='col-xs-4' style='padding:0px;' id='ratcell"+cellnum+"'><div class='albumnameblock'><h5 style='color:black;'>"+toplist[hnum].placenameru+"</h5><h1>"+toplist[hnum].regdate.day+"."+toplist[hnum].regdate.month+"."+toplist[hnum].regdate.year+"</h1></div><a href='http://recentones.com/places/"+toplist[hnum].pid+"'><img src='"+toplist[hnum].mainpreview+"' style='width:100%;'></a></div>";
                                eval("$('#row"+rnum+"').append(insert);");
                    if(xx+1 == times){
                     moreid = toplist[hnum].pid;
                     console.log('MOREID: '+moreid);
                    }
                    }
                    else 
                    {var insert = "<div class='col-xs-4' style='padding:0px;border-right:1px solid #ddd;' id='ratcell"+cellnum+"'><div class='albumnameblock'><h5 style='color:black;'>"+toplist[hnum].placenameru+"</h5><h1>"+toplist[hnum].regdate.day+"."+toplist[hnum].regdate.month+"."+toplist[hnum].regdate.year+"</h1></div><a href='http://recentones.com/places/"+toplist[hnum].pid+"'><img src='"+toplist[hnum].mainpreview+"' style='width:100%;'></a></div>";
                                eval("$('#row"+rnum+"').append(insert);");}
                  }
                  if(rnum===times && left != 3 && left != 0){
                  for (var yy=0;yy<left;yy++){
                    var leftrow = rnum+1;
                   $('#inserts').append("<div class='row' id='row"+leftrow+"'></div>");
                   var cellnum = rnum*3+yy+1;
                   console.log('cellnum: '+cellnum);
                   var hnum = cellnum-1;
                   console.log('hnum: '+hnum);
                    var insert = "<div class='col-xs-4' style='padding:0px;border-right:1px solid #ddd;' id='ratcell"+cellnum+"'><div class='albumnameblock'><h5 style='color:black;'>"+toplist[hnum].placenameru+"</h5><h1>"+toplist[hnum].regdate.day+"."+toplist[hnum].regdate.month+"."+toplist[hnum].regdate.year+"</h1></div><a href='http://recentones.com/places/"+toplist[hnum].pid+"'><img src='"+toplist[hnum].mainpreview+"' style='width:100%;'></a></div>";
                    eval("$('#row"+leftrow+"').append(insert);");
                    if(yy+1 == left){
                     moreid = toplist[hnum].pid;
                     console.log('MOREID: '+moreid);
                    }
                  }
                }}
         }
         }   
         $('#more').click(function(){
          request = new XMLHttpRequest();
          request.onreadystatechange = function () {
          var DONE = this.DONE || 4;
          if (this.readyState === DONE){
          parsed = JSON.parse(request.responseText);
          console.log(parsed);
          if(parsed.trouble === 1)
          {
          console.log('TROUBLE === 1');
          switch (parsed.mtext){
          case('db'):
          alert('Sorry, our database is being updated');
          break;
          case('empty'):
          break;
          }}
          else {
          //trouble === 0
          $('#inserts').empty();
          toplist = parsed.mdata;
          populate(toplist);
          }
          }
          };
          request.open('POST', '/more', true);
          request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Tells server that this call is made for ajax purposes.
          request.setRequestHeader("Content-type", "text/plain");
          //Most libraries like jQuery/Prototype/Dojo do this
          var eng = 'mult='+moreid;
          console.log('mult='+moreid);
          request.send(enq);
          });
          populate(toplist);
           
