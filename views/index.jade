doctype html(lang='en')
head
    meta(charset='utf-8')
    |     
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    |     
    meta(name='viewport', content='width=device-width, initial-scale=1')
    |     
    title Recent ones
    // Bootstrap
    link(href='/bootstrap/css/bootstrap.min.css', rel='stylesheet')
    link(href='/transitions/animations.css', rel='stylesheet')
    // HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries
    // WARNING: Respond.js doesn't work if you view the page via file://
    //if lt IE 9
      script(src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js')
      |       
      script(src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js')     
    style.
      @font-face {
      font-family:roboto-thin;
      src:url('/bootstrap/fonts/Roboto-Thin.ttf');
      }
      @font-face {
      font-family:high;
      src: url('/bootstrap/fonts/Attentica.ttf');
      }
      @font-face {
      font-family:br;
      src: url('/bootstrap/fonts/bebasneue_regular.ttf');
      }
      @font-face {
      font-family:bt;
      src: url('/bootstrap/fonts/bebasneue_thin.ttf');
      }
      body {
      min-width:768px;
      background-color:#ddd;
      }
      h5{
      letter-spacing:2px;
      text-transform:uppercase;
      margin-bottom:0px;
      color:white;
      font-family:roboto-thin;
      font-size:30px;
      margin-top:0px;
      }
      h2 {
      letter-spacing:2px;
      text-transform:uppercase;
      font-family:high;
      margin-bottom:0px;
      }
      h6{
      font-family:roboto-thin; 
      text-transform:uppercase;
      margin-top:0px;
      color:lightgray;
      margin-bottom:0px;
      letter-spacing:2px;
      }
      #welcome {
      position:absolute;
      z-index:3000;
      width:100%;
      height:100%;
      -ms-background-color:lightblue;
      }
      .main{
      #{filters}
      }
      .col-lg-4 {
      margin-bottom: 20px;
      text-align: center;
      }
      .list-group-item:last-child {
      border-bottom: 2px solid #c2c2c2;
      }
      .pt-perspective {
      position: relative;
      width: 100%;
      height: 100%;
      perspective: 1200px;
      transform-style: preserve-3d;
      }
      .pt-page {
      width: 100%;
      height: 100%;
      position: absolute;
      z-index:100;
      top: 0;
      left: 0;
      visibility: hidden;
      backface-visibility: hidden;
      transform: translate3d(0, 0, 0);
      }
      .pt-page-current,
      .no-js .pt-page {
      visibility: visible;
      z-index:200;
      }
      .no-js body {
      overflow: auto;
      }
      .pt-page-ontop {
      z-index: 999;
      }
      .away {
        display: inline-block;
        padding: 5px 14px;
        background-color: #4F4F4F; 
        border-radius:15px;
        margin-bottom:10px;
        color:#999999;
      }
      .away:hover {
      text-decoration: none;
      color:#09BCFD;
      }
      .back {
        background-color:#4F4F4F !important;
      }
      #close {
      padding: 10px 16px;
      font-size: 18px;
      line-height: 1.3333333;
      border-radius:30px;
      background-color:rgba(225,225,225,0.25);
      border-color:white;
      color:white;
      }
      #close:hover{
        text-decoration:none;
        color:#09BCFD;
        border:1px solid #09BCFD;
      }
  body
    script.
      if(screen.width < 414){
      window.location='http://m.recentones.com/';
      }
    
    nav(class="navbar navbar-inverse navbar-fixed-top",style='z-index:3001')
      .container
        .navbar-header
          a(class="navbar-brand" style='padding:5px;' href="/")
            img(alt="Logo",id='logo',src="/bootstrap/images/rl.png",height='40',width='40')
        .collapse.navbar-collapse#navbar-collapse-9
          ul(class='nav navbar-nav')
            li(class='active')
              a(href='#',style='font-family:high;font-size:20px;letter-spacing:2px;') Лента 
            li
              a(href='/top',style='font-family:high;font-size:20px;letter-spacing:2px;') Рейтинги 
            li
              a(href='/misc/1',style='font-family:high;font-size:20px;letter-spacing:2px;') Инфо 
          form(class="navbar-form navbar-right" id='srch' role="search")
           .input-group
              input(type="text" class="form-control" id='searchfield' style='background-color:#333;color:white;border-color:#333;border-top-left-radius:20px;border-bottom-left-radius:20px;') 
              span(class='input-group-btn')
                button(class="btn btn-default" type="button" id='searchbutton' style='padding-top:9px;padding-bottom:9px;background-color:#333;color:gray;border-color:#333;border-top-right-radius:20px;border-bottom-right-radius:20px;')
                  span(class='glyphicon glyphicon-search') 
    #wrap 
      #welcome(style='display:#{display}')
        .container(style='margin-bottom:60px;')
          .row  
            .col-xs-12(style='text-align:center;')
              h1(style='color:white;margin-top:35vh;margin-bottom:50px;font-size:45px;font-family:high;') Добро пожаловать, все дела, сайт о новых заведениях Москвы, пиу-пиу.
              a(id='close') Пропустите !  
      .pt-perspective(id='pt-main')
        .pt-page.pt-page-1(style='visibility:visible;')
          .main.container(style='margin-top:50px;z-index:2;',id='main')  
            .row
              #inserts.col-xs-12
          footer(class='footer main' id='morebutton' style='display:none;background-color:white;')
            .container
                nav
                  ul(class='pager') 
                    li 
                      a(id='more',style='font-family:roboto-thin;') Еще
        .pt-page.pt-page-2(id='panel' style='background-color:#333;height:100%;overflow:auto;')
      script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js')
      script(src='/transitions/modernizr.custom.js')
      script(src='/transitions/pagetransitions.js')
      script( async, type='text/javascript', src='/js/pano2vr_player.js')
      script.
        var rownum = 0;
        var lastfounddate;
        var more = #{more};
        if(more===1){
         $('#morebutton').css('display','block');
        }
        $('#close').click(function(){
          $("#welcome").css("display","none");
          $('.main').css({'filter':' brightness(1)','-o-filter':' brightness(1)','-moz-filter':' brightness(1)','-ms-filter':' brightness(1)','-webkit-filter':' brightness(1)'});
        });
        $(document).keypress(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13' && $('#searchfield').val()){
        $('#srch').submit  
        }
        });
        var toplist = !{doc};
        //$('#searchbutton').click(performsearch);
        //function performsearch(){
        //var query = $('#searchfield').val();
        //request = new XMLHttpRequest();
        //request.onreadystatechange = function () {
        //var DONE = this.DONE || 4;
        //if (this.readyState === DONE){
        //var parsed = JSON.parse(request.responseText);
        //if (parsed.trouble === 1)
        //{$('#fldc').css('padding-top','20px');
        //$('#searchresults').empty(); 
        //$('#searchresults').css('text-align','center');
        //$('#searchresults').append("<h5 style='margin-top:10vh;color:black;'>Ничего не нашли</h5>");}
        //else {
        //$('#fldc').css('padding-top','20px');
        //$('#searchresults').empty(); 
        //$('#searchresults').css('text-align','left');
        //for(var i = 0;i<parsed.length;i++){
        // var insert = "<div class='row' style='border-bottom:1px solid #ddd;background-color:#fff;'><a href='http://recentones.com/places/"+parsed[i].pid+"'><div class='col-xs-2' style='padding:0px;'><img src='"+parsed[i].mainpreview+"' style='width:100%'></div><div class='col-xs-10'><h5 style='color:gray;padding-top:1vw;'>"+parsed[i].placenameru+"</h5></div></a></div>";
        // $('#searchresults').append(insert);
        // }
        //}}
        //};
        //request.open('POST', '/srch', true);
        //request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Tells server that this call is made for ajax purposes.
        //request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        //// THAT NEEDS TO BE CORRECTED. IT SUPPOSED TO CHECK FOR ALL THE OFFERS BUT SERVER SIDE DOESNT SUPPORT IT YET. AT LEAST CHANGE TO 'CALENDAR'
        //request.send("query="+query); 
        //}
        // LOGO COLOURING
        var logocount=0;
        $('#logo').mouseenter(function(){
          if(logocount<3)
           {switch(logocount) {
                       case(0):
                        $('#logo').attr('src','/bootstrap/images/gl.png');
                        logocount++;
                       break;
                       case(1):
                        $('#logo').attr('src','/bootstrap/images/bl.png');
                        logocount++;
                       break;
                       case(2):
                         $('#logo').attr('src','/bootstrap/images/rl.png');
                        logocount++;
                       break;
                      }
                    }
            else {
              switch(logocount%3)
              {         case(0):
                         $('#logo').attr('src','/bootstrap/images/gl.png');
                         logocount++;
                        break;
                        case(1):
                         $('#logo').attr('src','/bootstrap/images/bl.png');
                         logocount++;
                        break;
                        case(2):
                         $('#logo').attr('src','/bootstrap/images/rl.png');
                         logocount++;
                        break;}
            }
          });
        
        function populate(toplist,funcmore) {
          var left = toplist.length%2;
          var cycles = (toplist.length-left)/2;
          console.log('cycles: '+cycles+', left: '+left);
          //functionality for a single item array must be implemented
          if(funcmore===0)
          {for(var xx=0;xx<cycles;xx++){
                      console.log('rownum is: '+rownum);
                      $('#inserts').append("<div class='row' style='margin-top:15px;margin-bottom:15px;' id='row"+rownum+"'></div>");
                      //branch for outputting left
                      if(xx+1 === cycles && left) {
                        var modrownum = rownum+1;
                        $('#inserts').append("<div class='row' style='margin-top:15px;margin-bottom:15px;' id='row"+modrownum+"'></div>");
                        var insert = "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[xx].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[xx].mainpreview+"' ></a></li></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[xx].placenameru+"</h2><h6>"+toplist[xx].founddate.day+"."+toplist[xx].founddate.month+"."+toplist[xx].founddate.year+"</h6></li></ul></div>";
                          eval("$('#row"+rownum+"').append(insert);");
                        lastfounddate=toplist[xx].founddateint;
                        $('#morebutton').css('display','none');
                      }
                      else {
                        
                          for(var yy=0;yy<2;yy++){
                          if(yy===0)
                          {var listnum = xx*2;
                           var insert = "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[listnum].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[listnum].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[listnum].placenameru+"</h2><h6>"+toplist[listnum].founddate.day+"."+toplist[listnum].founddate.month+"."+toplist[listnum].founddate.year+"</h6></li></ul></div>";
                           eval("$('#row"+rownum+"').append(insert);");}
                          else {
                            var listnum = xx*2+1;
                           var insert = "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[listnum].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[listnum].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[listnum].placenameru+"</h2><h6>"+toplist[listnum].founddate.day+"."+toplist[listnum].founddate.month+"."+toplist[listnum].founddate.year+"</h6></li></ul></div>";
                           eval("$('#row"+rownum+"').append(insert);");
                           lastfounddate=toplist[listnum].founddateint;
                          }
                          }//for populating row
                      
                      }//else from outputting left
                      rownum++;
                      console.log('rownum is: '+rownum);
                    }//for main cycle
                
                  }
          else {
             if(toplist.length>1){for(var xx=0;xx<cycles;xx++){
                                   console.log('MORE rownum is: '+rownum);
                                   var greatInsert ="<div class='row' style='margin-top:15px;margin-bottom:15px;display:none;' id='row"+rownum+"'>";
                                   
                                   //branch for outputting left
                                   console.log('breakpoint 1')
                                   
                                       
                                       for(var yy=0;yy<2;yy++){
                                       if(yy===0)
                                       {var listnum = xx*2;
                                         console.log('breakpoint 5');
                                         greatInsert += "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[listnum].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[listnum].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[listnum].placenameru+"</h2><h6>"+toplist[listnum].founddate.day+"."+toplist[listnum].founddate.month+"."+toplist[listnum].founddate.year+"</h6></li></ul></div>";
                                        }
                                       else {
                                         var listnum = xx*2+1;
                                         console.log('breakpoint 7');
                                         greatInsert += "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[listnum].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[listnum].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[listnum].placenameru+"</h2><h6>"+toplist[listnum].founddate.day+"."+toplist[listnum].founddate.month+"."+toplist[listnum].founddate.year+"</h6></li></ul></div>";
                                        eval("$('#row"+rownum+"').append(insert);");
                                        console.log('breakpoint 8');
                                        lastfounddate=toplist[listnum].founddateint;
                                       }
                                       }//for populating row
                                   
                                   if(xx+1 === cycles && left) {
                                     var modrownum = rownum+1;
                                      insert = "<div class='row' style='margin-top:15px;margin-bottom:15px;display:none' id='row"+modrownum+"'></div>";
                                     $('#inserts').append(insert);
                                     console.log('breakpoint 2');
                                      insert = "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a onclick='openpanel("+toplist[xx].pid+")'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[xx].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[xx].placenameru+"</h2><h6>"+toplist[xx].founddate.day+"."+toplist[xx].founddate.month+"."+toplist[xx].founddate.year+"</h6></li></ul></div>";
                                       eval("$('#row"+rownum+"').append(insert);");
                                     lastfounddate=toplist[xx].founddateint;
                                     $('#morebutton').css('display','none');
                                     console.log('breakpoint 3');
                                   }//if which populates with left ones
                                   
                                   console.log('breakpoint 9');
                                   //eval("$('#row"+rownum+"').fadeIn('slow');")
                                   greatInsert += '</div>';
                                   $(greatInsert).hide().appendTo('#inserts').fadeIn('slow');
                                   var rowName = '#row'+rownum;
                                   $('body, html').animate({ scrollTop: $(rowName).offset().top }, 1000);
                                   rownum++;
                                   console.log('MORE rownum is: '+rownum);
                                 }//for main cycle
                               }
                    else {
                      var greatInsert ="<div class='row' style='margin-top:15px;margin-bottom:15px;display:none;' id='row"+rownum+"'>";
                      greatInsert += "<div class='col-xs-6'><ul class='list-group'><li style='padding:0px;' class='list-group-item'><a href='http://recentones.com/places/"+toplist[0].pid+"'><img style='width:100%;border-top-left-radius:4px;border-top-right-radius:4px;' src='"+toplist[0].mainpreview+"' ></a></li><li class='list-group-item'><h2 style='margin-top:0px;'>"+toplist[0].placenameru+"</h2><h6>"+toplist[0].founddate.day+"."+toplist[0].founddate.month+"."+toplist[0].founddate.year+"</h6></li></ul></div>";
                      greatInsert += '</div>';
                      $(greatInsert).hide().appendTo('#inserts').fadeIn('slow');
                      var rowName = '#row'+rownum;
                      $('body, html').animate({ scrollTop: $(rowName).offset().top }, 1000);
                      rownum++;
                      console.log('MORE rownum is: '+rownum);

                    }
          }
        }
        //page position variable for height adjustment wihle switching between pages
        var pposition;
        function openpanel(pid) {
        request = new XMLHttpRequest();
        request.onreadystatechange = function () {
        var DONE = this.DONE || 4;
        if (this.readyState === DONE){
        parsed = JSON.parse(request.responseText);
        console.log(parsed);
        if(parsed.trouble === 1)
        {
        console.log('TROUBLE === 1');
        switch (parsed.mtext){
        case('db'):
        alert('Sorry, our database is being updated');
        break;
        case('empty'):
        alert('EMPTY');
        break;
        }}
        else {
        console.log('choice');
        //trouble === 0
        var place = parsed.place;
        if(!parsed.place.pano){
          console.log('empty');
          var placename = place.placenameru;
          var www = place.contacts.www;
          var adressru = place.adressru;
          var adressen = place.adressen;
          var phone = place.contacts.phone;
          var insert = "<div style='margin-top:60px;' class='container'><div class='row'><div class='col-xs-12'><nav><ul class='pager'><li class='previous'><a onclick='back()' style='color:#999999;border:0px;' class='back'>Назад</a></li></ul></nav></div></div><div class='row'><div class='col-xs-12'><ul class='list-group'><li style='padding:100px;text-align:center;background-color:inherit;border: 1px solid #4f4f4f;border-top-left-radius: 8px;border-top-right-radius: 8px;' class='list-group-item'><img src='/bootstrap/images/bl.png' style='width:10vw;margin-bottom:20px;'/><h5>Мы тур еще не отсняли &#40&#45&#58</h5></li><li style='padding-bottom:15px;border:1px solid #4f4f4f;border-bottom:1px solid #4f4f4f;background-color:inherit;border-bottom-right-radius:8px;border-bottom-left-radius:8px;' class='list-group-item'><a class='away' href='"+www+"'>На сайт</a><h5 style='color:#999999;font-size:15px;font-weight:bold;'>"+adressru+"</h5><h5 style='color:#747474;font-size:15px;font-weight:bold;margin-bottom:5px;'>"+adressen+"</h5><a href='tel:"+phone+"'><h5 style='color:#999999;font-size:15px;font-weight:bold;'>"+phone+"</h5></a></li></ul></div></div></div>";
          $('#panel').append(insert);
          pposition = $('#main').scrollTop();
          $('.pt-page-2').css('display','block').addClass('pt-page-moveFromRight pt-page-delay200 pt-page-ontop pt-page-current');
          $('.pt-page-1').removeClass('pt-page-current').css('overflow','hidden'); 
          console.log('did output');
        }
        else {
          console.log('haspano');
          var placename = place.placenameru;
          var adressru = place.adressru;
          var adressen = place.adressen;
          var www = place.contacts.www;
          var phone = place.contacts.phone
          var day = place.founddate.day;
          var month = place.founddate.month;
          var year = place.founddate.year;
          var xml = place.xml;
          var insert = "<div style='margin-top:50px;background-color:#eee;' class='container'><div class='row'><div class='col-xs-12'><h5 onclick='back'>Назад</h5></div></div><div id='text' class='row'><div style='text-align:center;' class='col-xs-10 col-xs-offset-1'><h1 style='margin-bottom:20px;margin-top:20px;font-family:high;font-size:45px;'>"+placename+"</h1><ul style='margin-bottom:20px;text-align:left;' class='list-group'><li style='padding:0px;' class='list-group-item'><div id='pano' style='height:400px;'></div></li><li class='list-group-item'><div role='alert' style='margin-top:10px;margin-bottom:10px;' class='alert alert-success alert-dismissible'><button type='button' data-dismiss='alert' aria-label='Close' class='close'><span aria-hidden='true'>&times;</span></button><strong>Двойной щелчок для перехода в полноэкранный режим</strong></div><h5>"+adressru+"</h5><h5 style='color:lightgray;'>"+adressen+"</h5><a href='"+www+"'><h5>Перейти на сайт заведения</h5></a><a href='tel:"+phone+"'><h5>"+phone+"</h5></a><h5>Заведение открылось "+day+"."+month+"."+year+"</h5></li></ul></div></div></div>";
          $('#panel').append(insert);
          pposition = $('#main').scrollTop();
          $('.pt-page-2').css('display','block').addClass('pt-page-moveFromRight pt-page-delay200 pt-page-ontop pt-page-current');
          $('.pt-page-1').removeClass('pt-page-current').css('overflow','hidden'); 
        }
        }
        }
        };
        request.open('POST', '/openpanel', true);
        request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Tells server that this call is made for ajax purposes.
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        //Most libraries like jQuery/Prototype/Dojo do this
        request.send('pid='+pid);
        };

        function back() {
           //console.log('get back');
           //$('.pt-page-2').removeClass('pt-page-moveFromRight pt-page-current pt-page-ontop').addClass('pt-page-moveToRight').empty().css('display','none');
           //$('.pt-page-1').addClass('pt-page-current').css('overflow','visible');
           //console.log(pposition);
           //$('#main').scrollTop(400);
           $('pt-page').css('overflow','visible');
           $('.pt-page-2').removeClass('pt-page-moveFromRight pt-page-ontop').addClass('pt-page-moveToRight');
        }

        $('#more').click(function(){
        request = new XMLHttpRequest();
        request.onreadystatechange = function () {
        var DONE = this.DONE || 4;
        if (this.readyState === DONE){
        parsed = JSON.parse(request.responseText);
        console.log(parsed);
        if(parsed.trouble === 1)
        {
        console.log('TROUBLE === 1');
        switch (parsed.mtext){
        case('db'):
        alert('Sorry, our database is being updated');
        break;
        case('empty'):
        alert('EMPTY');
        break;
        }}
        else {
        //trouble === 0
        toplist = parsed.mdata.reverse();
        //populate is modified , check if suitable
        populate(toplist,1);
        //$("html, body").animate({ scrollTop: $("#morebutton").scrollTop() }, 1000);
        if(parsed.more === 0){
        $('#morebutton').css('display','none');
        }
        }
        }
        };
        request.open('POST', '/more', true);
        request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Tells server that this call is made for ajax purposes.
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        //Most libraries like jQuery/Prototype/Dojo do this
        console.log('lastfounddate='+lastfounddate);
        request.send('lastfounddate='+lastfounddate);
        });
        populate(toplist,0);
           
