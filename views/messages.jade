doctype html
html(lang='en')
  head
    meta(charset='utf-8')
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    meta(name='viewport', content='width=device-width, initial-scale=1')
    // The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags
    title INTP Love
    // Bootstrap
    link(href='http://fonts.googleapis.com/css?family=Josefin+Sans&subset=latin,latin-ext', rel='stylesheet', type='text/css')
    link(href='/bootstrap/css/bootstrap.min.css', rel='stylesheet')
    link(href='//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css', rel='stylesheet')
    meta(liber de amicitia est)
    meta(property="og:url"           content="http://intplove.com")
    meta(property="og:type"          content="website")
    meta(property="og:title"         content="INTP INTJ LOVE")
    meta(property="og:description"   content="Place to find your INTP or INTJ half")
    meta(property="og:image"         content="http://intplove.com/images/intplove_logo.png")
    // HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries
    // WARNING: Respond.js doesn't work if you view the page via file://
    //if lt IE 9
    script(src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js')
    script(src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js')
    script(src='/js/share.js')
    style.
      body{
      background-color:#333;
      padding-bottom:30px;
      }
      .header {
      text-align:center;
      }
      .header h1 {
      margin-top:50px;
      text-transform: uppercase;
      }
      .header h4 {
      margin-top:20px;
      margin-bottom:30px;
      text-transform: uppercase;
      font-weight: 200;
      color: #bbb;
      }
      .footer {
      text-align:center;
      bottom: 0;
      width: 100%;
      }
      .participate {
      text-align:center;
      margin-top:50px;
      margin-bottom:70px;
      }
      .language {
      position:absolute;
      top:20px;
      right:20px;
      }
      #apply {
      display:none;
      }
      #ru_cont {
      display:none;
      }
      .user {
      border-bottom:1px solid #eee;
      padding-top:20px;
      padding-bottom:15px;
      padding-left:10px;
      }
      .user h5 {
      margin-top:0px;
      }
      .user:last-child {
      border-bottom:none;
      }
      .emptyavatar {
      /*margin:30px;
      margin-left:50px;
      margin-right:50px;*/
      margin:auto;
      width:90px;
      height:90px;
      background-color:#eee;
      border-radius:50%;
      }
      #main {
      background-color:white;
      border-radius:6px;
      }
      #mainholder {
      border-radius:6px;
      }
      #head {
      border: 1px solid #232323;
      padding-bottom:30px;
      text-align:center;
      border-top-left-radius:6px;
      border-top-right-radius:6px;
      background-color:#222;
      }
      h1{
      font-family:Josefin Sans;
      text-align:center;
      margin-bottom:80px;
      letter-spacing: 12px;
      color: #222;
      font-size:80px; 
      }
      #eng_cont {
      padding-top:45px;
      }
      @media (max-width: 767px) {
      body {
        background-color:#eee;
      }
      #eng_cont {
      padding-top:0px;
      }
      h1 {
        font-size:36px;
        margin-bottom:20px
      }
      .user h5 {
        margin-top:20px;
      }
      .user {
        text-align:center;
      }
      #head {
      border: 1px solid #232323;
      border-top-left-radius:0px;
      border-top-right-radius:0px;
      }
      #mainholder{
        border-radius:0px;
      }
      #main {
        border-radius:0px;
      }
      }
      h6 {
      color:#ddd;
      }
      #head .btn-default,#head .btn-default:hover,#head .btn-default:focus {
      border-color:teal;
      background-color:#333;
      color:teal;
      }
      #head .btn-default.active,#head .btn-default.active:active {
      border-color:teal;
      background-color:teal;
      color:#333;
      }
      .pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
      background-color:teal;
      border-color:teal;
      color:#333;
      }
      .pagination>li>a, .pagination>li>span {
      background-color:#333;
      border-color:teal;
      color:teal;
      }
      .btn-send {
      margin-top:20px;
      margin-bottom:5px;
      }
      .user .col-xs-9 {
      padding-left:10px;
      }
      .modal input {
      max-width:400px;
      }
      .user .col-xs-3 {
      text-align:center;
      }
      .glyphicon-map-marker {
        margin-right:5px
      }
      .loader {
      margin: 60px auto;
      margin-top:20%;
      font-size: 10px;
      position: relative;
      text-indent: -9999em;
      border-top: 1.1em solid rgba(255, 255, 255, 0.2);
      border-right: 1.1em solid rgba(255, 255, 255, 0.2);
      border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
      border-left: 1.1em solid #ffffff;
      -webkit-transform: translateZ(0);
      -ms-transform: translateZ(0);
      transform: translateZ(0);
      -webkit-animation: load8 1.1s infinite linear;
      animation: load8 1.1s infinite linear;
      }
      .loader,
      .loader:after {
        border-radius: 50%;
        width: 10em;
        height: 10em;
      }
      @-webkit-keyframes load8 {
        0% {
          -webkit-transform: rotate(0deg);
          transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }
      @keyframes load8 {
        0% {
          -webkit-transform: rotate(0deg);
          transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }
      .socialbtns .fa {
        width: 35px;
        height: 35px;
        margin-left:5px;
        margin-right:5px;
        background-color: #FFF;
        color:#158CF3;
        border-color:#fff;
        padding-top: 11px;
        border-radius: 22px;
        -moz-border-radius: 22px;
        -webkit-border-radius: 22px;
        -o-border-radius: 22px;
        border:1px solid #ff9900;
        transition: border-color 0.5s ease;
        margin-bottom: 5px;
      }
      /*.socialbtns .fa:hover {
        border:1px solid #333;
      }*/
      .regerr {
        margin-top:30px;
        margin-bottom:30px;
        text-align:center;
        display:none;
      }
      #resendveri {
        margin-top:30px;
        margin-bottom:30px;
        text-align:center;
        display:none;
      }
      a:focus, a:hover, a:active {
        color:#446179 !importnat;
        text-decoration:none !important;
      }
      #profile {
        margin-top:30px;
        border-bottom: 1px solid #323232;
        border-top: 1px solid #323232;
        text-align:center;
        transition:background-color 0.5s linear;
      }
      #profile a {
        color:#515558;
      }
      #profile .col-xs-3.active {
        background-color: #292929;
      }
      #profile .col-xs-3.active a {
      color:#3A6890;
      }
      #profile .col-xs-3:hover {
        background-color: #292929;
      }
      #profile .col-xs-3 {
        border-right:1px solid #333;
        text-align:center;
        padding:10px;
      }
      #profile .col-xs-3:last-child {
        border-right:none;
      }
      .form-control {
      border: 1px solid #555758;
      background-color: #424242 !important;
      color:white;
      }
      .badge {
        margin-left:5px;
      }
      .message {
        padding-top:20px;
        padding-bottom:20px;
        border-bottom:1px solid #eee;
        background-color:#fefefe;
      }
      .message:last-child {
        border-bottom:none;
        border-bottom-left-radius:6px;
        border-bottom-right-radius:6px;
      }
      .message.new:hover {
       border-bottom:1px solid #eee;
      }
      .message:hover {
      background-color:#eee;
      }
      .message h4 {
        color:#9a9a9a;
      }
      .badge {
      margin-left:5px;
      color:#ff9900;
      background-color: rgba(213, 136, 20, 0.3);
      border-radius: 4px;
      }
      #bottomNav {
        font-size:20px;
      }
      #bottomNav .active {
        background-color:#333;
        height:60px;
      }
      #bottomNav .glyphicon{
        top:0px;
        line-height:3;
      }
      #bottomNav .col-xs-3 {
        border-right:1px solid #333;
      }
      #bottomNav .col-xs-3:last-child {
        border-right:none;
      }
      .new {
        background-color:white;
      }
      .new h4 {
        color:#333;
      }
      .new h5, .new h6 {
        color:#09f;
      }
  body
    .modal.fade(id="show_msg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel")
      .modal-dialog(role="document")
        .modal-content
          .modal-header(style='background-color:#222;border-top-left-radius:6px;border-top-right-radius:6px;')
            button(type="button" class="close" data-dismiss="modal" aria-label="Close")
              span(aria-hidden="true") ×
            h4#modalh.modal-title(style='color:#ddd;') Message
          .modal-body 
            .media
              .media-left
                a(id='author_page')
                  img.media-object.img-circle#avatar
                  #avatar_empty.media-object(style='height:50px;background-color:#eee;width:50px;border-radius:50%;' alt='avatar')
              .media-body
                h3.media-heading#sender
                h6#time(style='color:#ddd;margin-bottom:20px;')
            p#textbody  
            #respond.row
              //label Response:
              textarea(id='gettext' rows="3" maxlength="2700" class='form-control txtfield' placeholder='Your message')
          .modal-footer(style='text-align:center;border-bottom-left-radius:6px;border-bottom-right-radius:6px;')
            a.btn(id='openrespond' style='color:white;background-color:#337AB7;') Respond
    .container(id='wait' style='background-color:rgba(0, 0, 0, 0.63);position:fixed;width:100%;height:100%;z-index:9999;display:none;')
        .row(id='spin') 
          .col-xs-12(style='text-align:center;')
            .loader
    #eng_cont.container
      .row(style='background-color:#333;')
        .col-xs-12
          h1 INTPLOVE
      #mainholder.row
        #main.col-xs-12.col-sm-8.col-sm-offset-2.col-md-6.col-md-offset-3.col-lg-6.col-lg-offset-3
          #head.row.hidden-xs
            .col-xs-12
              #profile.row
                .col-xs-3
                  a(href='/')
                    span(class='glyphicon glyphicon-search' style='margin-right:5px;') 
                    | Поиск
                .col-xs-3
                  a(href='/profile')
                    span(class='glyphicon glyphicon-user' style='margin-right:5px;') 
                    | Профиль
                .col-xs-3.active
                  a#messages(href='/messages') 
                    span(class='glyphicon glyphicon-envelope' style='margin-right:5px;') 
                    | Почта
                .col-xs-3
                  a(href='/logout') 
                    span(class='glyphicon glyphicon-log-out' style='margin-right:5px;') 
                    | Выйти  
    #ru_cont.container(style='display:none;')
    footer.footer.hidden-xs
      .container
        .row
          .col-xs-12
            h6(style='font-weight:200;margin-top:40px;color:#636363;') INTPLOVE 2015
            a(style='margin-bottom:30px;font-weight:200;', href='mailto:feedback@intplove.ru') Contact us
    footer.visible-xs(style='height:60px;width:100%;position:fixed;bottom:0px;background-color:#232323;')
      .col-xs-12.navbar-inverse.navbar-fixed-bottom
      .row#bottomNav
        .col-xs-3.text-center
          a(href="/") 
            i(class="glyphicon glyphicon-search")
            //
              br 
              |Поиск
        .col-xs-3.text-center
          a(href="/profile") 
            i(class="glyphicon glyphicon-user")
            //
              br 
              |Профиль
        .col-xs-3.text-center.active
          a(href="#") 
            i( id='envelope' class="glyphicon glyphicon-envelope")
            //
              br 
              |Сообщения
        .col-xs-3.text-center
          a(href="/logout") 
            i(class="glyphicon glyphicon-log-out")
            //
              br 
              |Выход
    // jQuery (necessary for Bootstrap's JavaScript plugins)
    script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js')
    // Include all compiled plugins (below), or include individual files as needed
    //script(src='/js/jquery.min.js')
    script(src='/js/bootstrap.min.js')
    script.
      $('#gettext').val('');
      var messages = !{JSON.stringify(messages)};
      var counter=0;
      var namestore = {};// used when preparing a modal to display a message
      var msgstore ={};
      var avatarcheck={};
      var more = #{more};
      if(more){
        $('#morebutton').slideToggle();
      }
      if(!messages)
      {}
      else
      {
      populatemsg(messages,1);
      }
      function populatemsg(messages,init) {
        messages.reverse();
        messages.forEach(function(element){
        if($('#noitems').is(':visible')) {
          $('#noitems').remove();
        }
        console.log(element.userpic);
        var avatar_insert = "<div style='height:50px;background-color: #ddd;width:50px;border-radius:50%;margin-left:10px;' class='media-object' alt='avatar'></div>";
        if(element.userpic) {
         avatar_insert = "<img style='height:50px;margin-left:10px;' src='/userpics/"+element.sndr+"_small.png' class='media-object img-circle' src='' alt='avatar'>";
        }
        msgstore[element.sndr] = element.textbody;
        namestore[element.sndr] = {'name':element.name,'userpic':element.userpic};
        var uid_n_qts = '"'+element.sndr+'"';
        var textbody = element.textbody.length>30?element.textbody.substring(0,30).replace(/<br \/>/g, '  ')+'...':element.textbody.replace(/<br \/>/g, '  ');
        textbody=textbody.replace('<br />',' ');
        var insert = "<div class='row message' id='row"+element.tmstmp+"' onclick='show_message("+uid_n_qts+","+element.tmstmp+")'><div class='col-xs-12'><div class='media' style='margin-top:0px;'><div class='media-left' id='cid"+element.tmstmp+"'>"+avatar_insert+"</div><div class='media-body' style='color:#bfbfbf;'><h5 class='hidden-xs' style='position:absolute;right:20px;font-weight:200;top:-10;'>"+date_out(element.tmstmp)+"</h5><h4 id='head"+element.tmstmp+"' class='media-heading'>"+element.name+"</h4><h6 class='visible-xs' style='font-weight:200;'>"+date_out(element.tmstmp)+"</h6>"+textbody+"</div></div></div></div>";
        //if(parseInt(#{lst_tmstmp})<parseInt(element.tmstmp) ){ 
          if(element.read ===0){
          
        insert = "<div class='row message new' id='row"+element.tmstmp+"' onclick='show_message("+uid_n_qts+","+element.tmstmp+")'><div class='col-xs-12'><span id='indicator"+element.tmstmp+"' style='color:#37AFD6;font-size: 40px;position: absolute;left: 15px;top:16px;'>&#8226;</span><div class='media' style='margin-top:0px;'><div class='media-left' id='cid"+element.tmstmp+"'>"+avatar_insert+"</div><div class='media-body' style='color:#bfbfbf;'><h5 class='hidden-xs' style='position:absolute;right:20px;font-weight:200;top:-10;'>"+date_out(element.tmstmp)+"</h5><h4 id='head"+element.tmstmp+"' style='color:#333;' class='media-heading'>"+element.name+"</h4><h6 class='visible-xs' style='font-weight:200;'>"+date_out(element.tmstmp)+"</h6>"+textbody+"</div></div></div></div>";
        //insert = "<div class='row message new' id='row"+element.tmstmp+"' onclick='show_message("+uid_n_qts+","+element.tmstmp+")'><div class='col-xs-12'><div class='media' style='margin-top:0px;'><div class='media-left' id='cid"+element.tmstmp+"'>"+avatar_insert+"</div><div class='media-body' style='color:#bfbfbf;'><h5 class='hidden-xs' style='position:absolute;right:20px;font-weight:200;top:-10;'>"+date_out(element.tmstmp)+"</h5><h4 id='head"+element.tmstmp+"'  class='media-heading'>"+element.name+"</h4><h6 class='visible-xs' style='font-weight:200;'>"+date_out(element.tmstmp)+"</h6>"+textbody+"</div></div></div></div>";
        }
        $('#main').append(insert);
        });
      }
      $('#openrespond').click(function(){
        if($('#respond').css('display')==='block' && $('#gettext').val())
        {
          sendmsg($('#gettext').attr('rcvr'));
        }
        else if($('#respond').css('display')==='none') {
          var txt = 'Send';
          //if(user.lang === 'ru'){
          //  txt='Отправить';
          //}
         $('#openrespond').text(txt);
         $('#gettext').val('');
         $('#respond').slideToggle();
        }
        else {
        }
        });
      var iter = 1
      $('#loadmore').click(function(){
        $('#loadmore').prop('disabled',true);
        $.ajax({
              method: "POST",
              url: "/moremsg",
              data: 'iter='+iter
            }).done(function( msg ) {
                $('#loadmore').prop('disabled',false);
                if(msg.troube){
                  console.log('err loading messages');
                }
                  else {
                    iter++;
                   populatemsg(msg.msgstore,0);
                   if(!msg.more){
                    $('#morebutton').slideToggle();
                   }
                  }
               });
        });
      $.ajax({
              method: "POST",
              url: "/ntfc_m",
              data: 0
            }).done(function( msg ) {
                if(msg.newmsg){
                 $('#mbutton').append('<span style="vertical-align:baseline;color:#37AFD6;font-size:20px;margin-left:10px;">•</span>');
                 $('#menu-toggle').css('color','#37AFD6');
                }
               });
      function date_out(timestmp) {
        var d = new Date(timestmp),
        minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),
        hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours();
        //ampm = d.getHours() >= 12 ? 'pm' : 'am',
        //months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        //days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        //return days[d.getDay()]+' '+months[d.getMonth()]+' '+d.getDate()+' '+d.getFullYear()+' '+hours+':'+minutes+ampm;
        return hours+':'+minutes+'   '+d.getDate()+'.'+d.getMonth()+'.'+d.getFullYear();
      }
      function show_message (uid,tmstmp) {
      var tmstmp = parseInt(tmstmp);
      var time = new Date(tmstmp);
       var link = '/'+namestore[uid].name;
       console.log(namestore[uid].userpic+' - userpic');
       if(namestore[uid].userpic)
       {console.log('has userpic');
        $('#avatar').attr('src','/userpics/'+uid+'_small.png').css('display','block');
        $('#avatar_empty').css('display','none');
        }else{
        $('#avatar_empty').css('display','block');
        $('#avatar').css('display','none');
       }
       $('#author_page').attr('href',link);
       $('#sender').empty();
       $('#sender').append(namestore[uid].name);
       $('#time').text(date_out(tmstmp));
       $('#textbody').empty();
       $('#textbody').append(msgstore[uid]);
       $('#openrespond').text('Respond');
       $('#gettext').val('');
       $('#respond').css('display','none');
       $('#show_msg').modal('show');
       var onclick = "sendmsg('"+uid+"')";
      // $('#submitmsg').attr('onclick',onclick);
       $('#gettext').attr('rcvr',uid);
       eval("if($('#indicator"+tmstmp+"').is(':visible')){console.log('yo');mark_msg_read(tmstmp);}");
      }
      function mark_msg_read (tmstmp) {
      $.ajax({
              method: "POST",
              url: "/stlstmsg",
              data: 'tmstmp='+tmstmp
            }).done(function( msg ) {
                eval("$('#indicator"+tmstmp+"').remove()");
                eval("$('#row"+tmstmp+"').removeClass('new');");
                if(msgnum) {
                  msgnum--;
                  if(msgnum)
                  {$('#msgnumindicator').text('+'+msgnum);}
                  else {
                    $('#msgnumindicator').remove();
                    $('#envelope').css('color','#337ab7');
                  }
                }
               });
              }
      function sendmsg(rcvr) {
      console.log('msg sendin'); 
      //var rcvr = #{rcvrid}; 
      var sndr = '#{user}';
      var txtbody = $('#gettext').val();
      if(!txtbody) {
        return 0
      }
      console.log(txtbody);
      sndrequest = new XMLHttpRequest();
      sndrequest.onreadystatechange = function () {
      var DONE = this.DONE || 4;
      if(sndrequest.readyState==4 && sndrequest.status==200){
      $('#gettext').val('');
      $('#show_msg').modal('hide');
      $('#openrespond').text('Respond');
      //if (this.readyState === DONE){
      var parsed = JSON.parse(sndrequest.responseText);
      if(parsed.trouble === 1)
      {
      // TO DO do somewthing here
      alert('trouble');
      }
      else {
      }
      }
      };
      sndrequest.open('POST', '/msg', true);
      sndrequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Tells server that this call is made for ajax purposes.
      sndrequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      //Most libraries like jQuery/Prototype/Dojo do this
      sndrequest.send('rcvr='+rcvr+'&txtbody='+txtbody);
      }
      var msgnum=0;
      $.ajax({
              method: "POST",
              url: "/ntfc_m",
              data: 0
            }).done(function( msg ) {
                if(msg.newmsg){
                  //TODO if message number is to large do 99 or smth
                  console.log(msg.newmsg);
                  msgnum = msg.newmsg;
                 $('#messages').append('<span id="msgnumindicator" class="badge">+'+msg.newmsg+'</span>');
                 $('#envelope').css('color','#ff9900');
                }
               });
      
          

